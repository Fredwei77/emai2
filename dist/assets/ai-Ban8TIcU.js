import"./components-Dw_Wk6EH.js";(function(){const K=document.getElementById("agent-form"),M=document.getElementById("agent-input"),g=document.getElementById("agent-messages"),j=typeof document<"u"?document.getElementById("agent-image"):null,F=typeof document<"u"?document.getElementById("agent-image-btn"):null,S=typeof document<"u"?document.getElementById("agent-image-preview"):null,w=[];let T="";const E=[],_=2*1024*1024,Q=1280,v=document.getElementById("model-select"),x=document.getElementById("temp-input"),I=document.getElementById("top-p-input"),U=document.getElementById("max-tokens-input"),B=document.getElementById("temp-value"),A=document.getElementById("top-p-value"),O=document.getElementById("enable-tools"),Z=document.getElementById("tools-panel"),ee=document.getElementById("tool-fetch-url-text"),te=document.getElementById("tool-json-path"),ne=document.getElementById("tool-web-search"),oe=document.getElementById("tool-current-time"),re=typeof document<"u"?document.querySelectorAll('input[name="tool-choice"]'):[];function ae(){let t="auto";return re?.forEach?.(e=>{e.checked&&(t=e.value)}),t}function se(){if(!O?.checked)return;const t=[];return ee?.checked&&t.push({type:"function",function:{name:"fetch_url_text",description:"Fetch HTML/JSON and return plain text or truncated JSON",parameters:{type:"object",properties:{url:{type:"string"},limit:{type:"number"}},required:["url"]}}}),te?.checked&&t.push({type:"function",function:{name:"http_get_json_path",description:"GET JSON and extract value via dotted path with optional [index] segments",parameters:{type:"object",properties:{url:{type:"string"},path:{type:"string"}},required:["url","path"]}}}),ne?.checked&&t.push({type:"function",function:{name:"web_search",description:"Lightweight web search using DuckDuckGo HTML results",parameters:{type:"object",properties:{query:{type:"string"},limit:{type:"number"}},required:["query"]}}}),oe?.checked&&t.push({type:"function",function:{name:"current_time",description:"Return current server ISO datetime",parameters:{type:"object",properties:{}}}}),t.length?t:void 0}function R(){const t=!!O?.checked;Z?.querySelectorAll?.("input,select,button")?.forEach?.(e=>{e.id!=="enable-tools"&&(e.disabled=!t,e.closest("label")?.classList?.toggle("opacity-50",!t))})}O?.addEventListener("change",R),R(),j?.addEventListener("change",async()=>{try{const t=Array.from(j.files||[]);for(const e of t){let n=e;if(n.size>_)try{n=await ie(n,Q,.85,_)}catch{}const d=URL.createObjectURL(n);E.push({file:n,url:d})}P(),j.value=""}catch{}});function P(){S&&(S.innerHTML="",E.forEach((t,e)=>{const n=document.createElement("div");n.className="relative w-20 h-20 border border-gray-200 rounded overflow-hidden";const d=document.createElement("img");d.src=t.url,d.alt="selected image",d.className="w-full h-full object-cover";const o=document.createElement("button");o.type="button",o.className="absolute top-0 right-0 bg-white/80 hover:bg-white text-red-600 text-xs px-1 rounded-bl",o.innerText="×",o.title="移除",o.addEventListener("click",()=>{try{URL.revokeObjectURL(t.url)}catch{}E.splice(e,1),P()}),n.appendChild(d),n.appendChild(o),S.appendChild(n)}))}async function ie(t,e,n,d){const o=document.createElement("img"),r=await J(t);await new Promise((f,y)=>{o.onload=f,o.onerror=y,o.src=r});const{naturalWidth:i,naturalHeight:a}=o;let c=i,p=a;Math.max(i,a)>e&&(i>=a?(c=e,p=Math.round(a*(e/i))):(p=e,c=Math.round(i*(e/a))));const m=document.createElement("canvas");m.width=c,m.height=p,m.getContext("2d").drawImage(o,0,0,c,p);let s=n,u=await new Promise(f=>m.toBlob(f,"image/jpeg",s));for(;u&&u.size>d&&s>.5;)s-=.1,u=await new Promise(f=>m.toBlob(f,"image/jpeg",s));const l=new File([u],t.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"});return l.size<t.size?l:t}async function ce(){const t=["/api/models","/.netlify/functions/models"];let e=[];for(const r of t)try{const i=await fetch(r);if(!i.ok)throw new Error(`HTTP ${i.status}`);const a=await i.json();if(Array.isArray(a?.data)){e=a.data;break}if(Array.isArray(a)){e=a;break}}catch{}(!Array.isArray(e)||e.length===0)&&(e=[{id:"google/gemini-2.5-flash:free",name:"Gemini 2.5 Flash (free)"},{id:"google/gemini-2.5-flash-image-preview:free",name:"Gemini 2.5 Flash Image Preview (free)"}]),new Set(e.map(r=>r&&(r.id||r.value||r.name)).filter(Boolean));const n=e.map(r=>r?.id).filter(Boolean),o=e.filter(r=>typeof r?.id=="string"&&r.id.includes(":free"))[0]?.id||n[0]||"google/gemma-2-2b-it:free";if(T=o,v){const r=[];for(const s of[...v.options])r.push({v:s.value,t:s.textContent});v.innerHTML="";const i=(s,u)=>{const l=document.createElement("option");l.value=s,l.textContent=u||s,v.appendChild(l)},a=["openai","google","anthropic","meta","mistralai","cohere","qwen","baichuan","xai","hf","perplexity","deepseek","01-ai","databricks","nvidia","ai21"],c=s=>{const u=(s||"").split("/")[0],l=a.indexOf(u);return l>=0?l:a.length+1},p=s=>({"openai/gpt-4o-mini:free":"OpenAI GPT-4o mini (free)","google/gemini-2.5-flash-image-preview:free":"Gemini 2.5 Flash Image Preview (free)","google/gemini-2.5-flash:free":"Gemini 2.5 Flash (free)","google/gemma-2-2b-it:free":"Gemma 2 2B IT (free)"})[s]||s,m=Array.from(new Set(e.map(s=>s?.id).filter(Boolean)));m.sort((s,u)=>{const l=s.includes(":free")?0:1,f=u.includes(":free")?0:1;if(l!==f)return l-f;const y=c(s),L=c(u);return y!==L?y-L:String(s).localeCompare(String(u))});for(const s of m)i(s,p(s));const h=new Set([...v.options].map(s=>s.value));for(const s of r)s.v&&!h.has(s.v)&&i(s.v,s.t||s.v);v.value=o}}ce();function le(t){return typeof t=="string"&&/gemini|gpt-4o|gpt-4.1|llama-vision|vision|image|multimodal/i.test(t)}function H(){const t=v?.value||T,e=le(t);F?.classList?.toggle("opacity-50",!e),F?.classList?.toggle("pointer-events-none",!e),e||(E.forEach(n=>{try{URL.revokeObjectURL(n.url)}catch{}}),E.length=0,P())}v?.addEventListener("change",H),setTimeout(H,0),x&&B&&(B.textContent=x.value),I&&A&&(A.textContent=I.value),x?.addEventListener("input",()=>{B&&(B.textContent=x.value)}),I?.addEventListener("input",()=>{A&&(A.textContent=I.value)});let k=null,D=!1;function N(t){D=t;const e=document.getElementById("agent-run"),n=document.getElementById("agent-stop");e&&(e.disabled=t),n&&(n.disabled=!t),M?.toggleAttribute?.("disabled",t)}function b(t,e){const n=document.createElement("div");n.className="rounded-lg p-3 border "+(t==="error"?"bg-red-50 border-red-200 text-red-700":"bg-yellow-50 border-yellow-200 text-yellow-800"),n.innerText=e,g.appendChild(n),g.scrollTop=g.scrollHeight}function G(t,e){const n=document.createElement("div");n.className=t==="user"?"p-3 rounded-lg bg-blue-50 text-blue-900 whitespace-pre-wrap":"p-3 rounded-lg bg-gray-100 text-gray-900 whitespace-pre-wrap",n.innerText=e,g.appendChild(n),g.scrollTop=g.scrollHeight}async function J(t){return new Promise((e,n)=>{const d=new FileReader;d.onload=()=>e(d.result),d.onerror=n,d.readAsDataURL(t)})}async function $(t,e){try{const n=Array.isArray(e)?e:[];if(!n.length)return t;const d=[...t].map((a,c)=>({m:a,i:c})).reverse().find(a=>a.m&&a.m.role==="user")?.i;if(d===void 0)return t;const o=t.map(a=>({...a})),r=o[d],i=typeof r.content=="string"?[{type:"text",text:r.content}]:Array.isArray(r.content)?r.content.slice():[];for(const a of n)try{const c=await J(a.file);i.push({type:"image_url",image_url:{url:c}})}catch{}return o[d]={...r,content:i},o}catch{return t}}function de(){const t=document.createElement("div");return t.className="p-3 rounded-lg bg-gray-50 text-gray-500 text-sm flex items-center gap-2",t.innerHTML='<svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10" stroke="currentColor" stroke-width="2"/></svg> 思考中…',g.appendChild(t),g.scrollTop=g.scrollHeight,t}async function q({prompt:t,messages:e,model:n,temperature:d,top_p:o,max_tokens:r,tools:i,tool_choice:a,signal:c}){const p={model:n||T,prompt:t,messages:e,...d!==void 0?{temperature:d}:{},...o!==void 0?{top_p:o}:{},...r!==void 0?{max_tokens:r}:{},...i?{tools:i}:{},...a?{tool_choice:a}:{}},m=["/api/ai-chat","/.netlify/functions/ai-chat"],h=[];for(const u of m)try{const l=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p),...c?{signal:c}:{}});if(!l.ok){const y=await l.text();throw new Error(`HTTP ${l.status} ${y}`)}const f=await l.json();if(f?.ok)return f;throw new Error(f?.error||"Unknown server error")}catch(l){console.warn("AI API call failed at",u,l),h.push({url:u,message:l?.message||String(l)})}const s=h.length?"："+h.map(u=>`${u.url}: ${u.message}`).join(" | "):"";throw new Error("无法连接到服务器端 AI 代理，请检查部署与环境变量"+s)}async function ue({prompt:t,messages:e,model:n,temperature:d,top_p:o,max_tokens:r,tools:i,tool_choice:a,onDelta:c,signal:p}){const m={model:n||T,prompt:t,messages:e,...d!==void 0?{temperature:d}:{},...o!==void 0?{top_p:o}:{},...r!==void 0?{max_tokens:r}:{},...i?{tools:i}:{},...a?{tool_choice:a}:{}},h=["/api/ai-chat/stream","/api/ai-chat-stream","/.netlify/functions/ai-chat-stream"],s=new TextDecoder;for(const u of h)try{const l=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m),...p?{signal:p}:{}});if(!l.ok||!l.body)throw new Error(`HTTP ${l.status}`);const f=l.body.getReader();let y="";for(;;){const{value:L,done:he}=await f.read();if(he)break;y+=s.decode(L,{stream:!0});const W=y.split(`

`);y=W.pop()||"";for(const ye of W){const z=ye.trim();if(!z)continue;const V=z.split(`
`).find(C=>C.startsWith("data:"));if(!V)continue;const X=V.replace(/^data:\s*/,"");if(X==="[DONE]")return!0;try{const C=JSON.parse(X),Y=C?.choices?.[0]?.delta?.content??C?.choices?.[0]?.message?.content??"";Y&&c?.(Y)}catch{}}}return!0}catch(l){console.warn("AI stream failed at",u,l)}throw new Error("无法连接到服务器端 AI 流式代理")}function pe(t,e){setTimeout(()=>{e?.remove?.();const n=`已收到指令：${t}
(演示模式) 示例输出：
- 任务分析：解析指令并拆分步骤
- 可执行方案：生成内容或提供建议
- 下一步：在服务端配置 OPENROUTER_API_KEY 并部署函数`;G("assistant",n)},700)}(typeof document<"u"?document.getElementById("btn-health"):null)?.addEventListener("click",async()=>{const t=["/api/ai-health","/.netlify/functions/ai-health"],e=[];let n=null;for(const c of t)try{const p=await fetch(c),m=await p.text();if(e.push({url:c,status:p.status,ok:p.ok,raw:m.slice(0,200)}),!p.ok)continue;try{n=JSON.parse(m)}catch(h){e[e.length-1].parseError=h?.message||"Invalid JSON"}if(n)break}catch(p){e.push({url:c,error:p?.message||String(p)})}const d=!n;n||(n={ok:!0,env:{present:!1},durationMs:0,notice:"client-fallback"});const o=[];o.push("健康检查:"),o.push("来源: "+(d?"前端回退（未连接到服务器）":"服务器函数")),o.push("env.present: "+(n?.env?.present?"true":"false"));const r=n?.upstream?.models,i=n?.upstream?.chat;r&&o.push("models: "+(r.ok?`ok (count=${r.count||0}, pick=${r.pick||"-"})`:`error: ${r.error||"-"}`)),i&&o.push("chat: "+(i.ok?`ok (model=${i.model||"-"})`:`error: ${i.error||"-"} (model=${i.model||"-"})`));const a=typeof n?.durationMs=="number"&&n.durationMs>=0?n.durationMs:"-";if(o.push("duration: "+a+"ms"),e.length){o.push("探测详情:");for(const c of e)c.error?o.push(`- ${c.url}: error=${c.error}`):(o.push(`- ${c.url}: status=${c.status} ok=${c.ok}`),c.parseError&&o.push(`  parseError=${c.parseError}`))}b(n?.ok?"warn":"error",o.join(`
`))});const me=document.getElementById("agent-stop"),fe=document.getElementById("agent-clear"),ge=document.getElementById("agent-copy");me?.addEventListener("click",()=>{try{k?.abort(),b("warn","已停止当前生成")}catch{}N(!1)}),fe?.addEventListener("click",()=>{g.innerHTML="",w.length=0,b("warn","已清空会话")}),ge?.addEventListener("click",async()=>{try{const t=w.map(e=>`${e.role}: ${typeof e.content=="string"?e.content:JSON.stringify(e.content)}`).join(`
`);await navigator.clipboard.writeText(t||""),b("warn","已复制到剪贴板")}catch{b("error","复制失败，请手动选择文本复制")}}),K?.addEventListener("submit",async t=>{t.preventDefault();const e=(M?.value||"").trim();if(D){b("warn","有任务正在进行，请先停止或稍候");return}if(!e)return;G("user",e),w.push({role:"user",content:e}),M.value="";const n=de();N(!0),k=new AbortController;try{const d=v?.value||T,o=x?parseFloat(x.value):void 0,r=I?parseFloat(I.value):void 0,i=U?parseInt(U.value,10):void 0,a=document.createElement("div");a.className="p-3 rounded-lg bg-gray-100 text-gray-900 whitespace-pre-wrap",a.textContent="",g.appendChild(a),g.scrollTop=g.scrollHeight;let c="";const p=se(),m=ae();let h=!1;try{h=await ue({prompt:e,messages:await $(w,E),model:d,temperature:isNaN(o)?void 0:o,top_p:isNaN(r)?void 0:r,max_tokens:isNaN(i)?void 0:i,tools:p,tool_choice:m,signal:k.signal,onDelta:l=>{c+=l,a.textContent=c}})}catch(l){console.warn("AI stream failed, falling back to non-streaming endpoint",l)}if(h){if(!c||!c.trim())try{const f=(await q({prompt:e,messages:await $(w,E),model:d,temperature:isNaN(o)?void 0:o,top_p:isNaN(r)?void 0:r,max_tokens:isNaN(i)?void 0:i,tools:p,tool_choice:m,signal:k.signal}))?.output||"(无输出)";a.textContent=f,w.push({role:"assistant",content:f})}catch(l){console.warn("Fallback non-streaming call failed",l),a.textContent="(无输出)"}else w.push({role:"assistant",content:c||""});n.remove(),N(!1),k=null;return}const s=await q({prompt:e,messages:await $(w,E),model:d,temperature:isNaN(o)?void 0:o,top_p:isNaN(r)?void 0:r,max_tokens:isNaN(i)?void 0:i,tools:p,tool_choice:m,signal:k.signal});n.remove();const u=s?.output||"(无输出)";a.textContent=u,w.push({role:"assistant",content:u})}catch(d){console.error(d),d?.name==="AbortError"?b("warn","生成已取消"):b("error","发生错误："+(d?.message||"未知错误")),pe(e,n)}finally{N(!1),k=null}})})();
